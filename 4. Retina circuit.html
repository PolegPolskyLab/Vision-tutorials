<!DOCTYPE html>
<html>
<style>
p.groove {background-color: lightgrey;}
span.groove1 {border-left-style: groove;background-color: lightgrey;}
</style>
<body>
<p><b>Retinal circuits</b></p>
	Light levels:</p>
<button  type="button" id="Light0">0% (dark)</button>
<button  type="button" id="Light15">15%</button>
<button  type="button" id="Light50">50% (baseline)</button>
<button  type="button" id="Light85">85%</button>
<button  type="button" id="Light100">100% (bright)</button>
	<!-- <p>Ganglion cell types:</p> -->
<!-- <button  type="button" id="OnFoveal">On Foveal</button> -->
<!-- <button  type="button" id="OffFoveal">Off Foveal</button> -->
<!-- <button  type="button" id="ONCentersmall">On-Center Small</button> -->
<!-- <button  type="button" id="ONCenterlarge">On-Center Large</button> -->
<p>1D retina (side view)</p>
<canvas id="RetinaCanvas" width="600" height="200" style="border:1px solid #d3d3d3;position:relative;left: 0px;top:-10px"></canvas>

<div>

	<p style="position: relative;left: 0px;top:-10px">Photoreceptor ––> Horizontal (+):<sub> weak
	<input type="range" min="0" max="10" value="6" id="Ph_Hz" style="width: 80px;" >strong </sub>
	 <p style="position: relative;left: 0px;top:-20px">Horizontal ––> Photoreceptor (-):<sub> weak
	<input type="range" min="0" max="10" value="8" id="Hz_Ph" style="width: 80px;">strong </sub>
	</p>
	<p style="position: relative;left: 0px;top:-30px">Photoreceptor ––> Bipolar (-/+):<sub> weak
	<input type="range" min="0" max="10" value="8" id="Ph_Bip" style="width: 80px;">strong </sub>
	</p>
	<!-- <p style="position: relative;left: 0px;top:-40px">B ––>A (+):<sub> weak -->
	<!-- <input type="range" min="0" max="10" value="5" id="Bip_AC" style="width: 80px;">strong </sub></p> -->
</div>
<div style="position:relative;left: 620px;top:-440px">
	<p>2D retina (top view)</p>
	<canvas id="ImageCanvas" width="230" height="380" style="border:1px solid #d3d3d3;position:relative;left: 0px;top:-15px"></canvas>
</div>
<!-- <div style="border:1px solid #d3d3d3;background-color: #F0F0F0;position: relative;left: 0px;top:-40px; width: 260px;height: 290px;"> -->
	<!-- <p style="position: relative;left: 5px;top:-10px"><b>Ganglion cell:</b></p> -->
	<!-- <p style="position: relative;left: 5px;top:-20px"><b>Center: </b><input type="number" id="G_C_Num" value="1" min="1" max="9" width="20" > -->
	<!-- <p style="position: relative;left: 15px;top:-30px"> -->
	<!-- On B–> (+):<sub> weak -->
	<!-- <input type="range" min="0" max="10" value="5" id="ONBip_GC" style="width: 80px;">strong </sub> -->
	<!-- <p style="position: relative;left: 15px;top:-40px">Off B–> (+):<sub> weak -->
	<!-- <input type="range" min="0" max="10" value="0" id="OFFBip_GC" style="width: 80px;">strong </sub> -->
	<!-- <p style="position: relative;left: 15px;top:-50px"> -->
	<!-- On A–> (-):<sub> weak -->
	<!-- <input type="range" min="0" max="10" value="0" id="A_GC" style="width: 80px;"s>strong </sub> -->
	<!-- </p> -->
	<!-- <p style="position: relative;left: 5px;top:-60px"><b>Surround: </b> -->
	<!-- <p style="position: relative;left: 15px;top:-70px"> -->
	<!-- On B–> (+): <sub>weak -->
	<!-- <input type="range" min="0" max="10" value="0" id="ONBip_GS" style="width: 80px;">strong </sub> -->
	<!-- <p style="position: relative;left: 15px;top:-80px">Off B–> (+): <sub>weak -->
	<!-- <input type="range" min="0" max="10" value="0" id="OFFBip_GS" style="width: 80px;">strong </sub> -->
	<!-- <p style="position: relative;left: 15px;top:-90px"> -->
	<!-- On A–> (-):<sub> weak -->
	<!-- <input type="range" min="0" max="10" value="0" id="A_GS" style="width: 80px; background-color: blue;">strong </sub> -->
	<!-- </p> -->
<!-- </div> -->

	<div style="position: relative;left: 0px;top:-460px">
	<p ><b>Instructions:</b></p>
	<p><b>Overview:</b> In this interactive tutorial we will examine how neuronal interactions affect retinal visual output. 
	Most neurons in the retina do not fire action potentials (spikes). Instead, they respond to light with graded potentials as we have seen before. 
	Here, these changes are presented in pseudo-color, with green indicating depolarization (more positive voltage) and violet hyperpolarization (more negative voltage). 
	Ganglion cells do generate action potentials. We can only ‘see’ spikes coming from these cells – thus ganglion cell spikes form the output of the retina.

	<p>The left plot shows a side view of the retina. Squares above each photoreceptor indicate the light level illuminating that cell. 
	We can assume that the retina is adapted to the grey light and doesn’t respond to it. 
	Go ahead and change light levels! As we have seen before, photoreceptors depolarize to darkness and hyperpolarize to light. 
	This preference to light decrement (recall that neurons release more neurotransmitter upon depolarization) makes them an ‘Off’ cell. 
	Not all cells in the retina have the same preference – some cells depolarize to light increment, which makes them an ‘On’ cell. 
	‘Off’-‘On’ signal inversion occurs at the synapse between photoreceptors and some bipolar cells. 
	Like photoreceptors, bipolar cells release glutamate, which activates amacrine and ganglion cells. 
	Amacrine cells typically release inhibitory neurotransmitters and are the most diverse retinal cell in terms of different subtypes (more than a 50!). 
	In this tutorial we will limit the examination to photoreceptors, horizontal and bipolar cell.
	<p>1.1. Synaptic strength<p>
	We can change the strengths of synaptic connections between different cells from controls located below the plot. 
	(+) and (-) signs indicate the type of synaptic input – excitatory (depolarizing) or inhibitory (hyperpolarizing). 
	 Note that there are both plus and minus signs next to the Photoreceptor––>Bipolar synapse. Why is that so?
	
	<p>If you have not done so, change the signal above the photoreceptor to bright light. 
	You will see that the ‘On’ pathway becomes activated. You may have noticed that something is also happening to the images on the right of the controls. 
	These plots show how different cells in the retina perceive a visual input. You can examine responses to different images by clicking on the plot. 
	
	<p>1.2. Horizontal cells<p>
	Horizontal cells have two main roles in the circuit. They help to create the <b>center-surround</b> receptive field organization and they set the <b>dynamic range</b> of the retina, reducing saturation of photoreceptors. 
	Horizontal cells get their synaptic inputs from photoreceptors. 
	Their output is inhibitory, mainly going back to the photoreceptors –this process is known as ‘feedback inhibition’ and has important implications on formation of ‘center-surround’ receptive fields.
	 When all photoreceptors ‘see’ grey, the network is silent. 
	 <p>Switch the light on above the central photoreceptor. 
	 The light should hyperpolarize the photoreceptor by 20mV (this is the peak activation in this tutorial). 
	 Observe what happens to its neighboring cells that not experience light directly. 
	To understand what is happening, look at the voltages of the horizontal cells. 
	Recall that they inhibit their targets. Therefore, a positive voltage in a horizontal cell will reduce the voltage of a photoreceptor and a negative horizontal potential would increase photoreceptor activity. 
	<p>1.3. Center-Surround<p>
	The most important organization principle in the retina is center-surround receptive field. 
	What this means is that neurons in the retina are sensitive not only to light conditions directly above them (center), but also to signals in their surround. 
	Typically, same polarity surround inhibits center responses (On cells are inhibited by light increment in the surround and vice versa for Off cells). 
	Therefore, peak activation requires signals with opposing polarity in the center and the surround.
	Horizontal cells form the center-surround properties of photoreceptors and bipolar cells. Amacrine cells diversify the center-surround properties of bipolar and ganglion cells. Examine the plots on the right. In the absence of horizontal cells (as you can get by setting Ph->Hz to 0), each photoreceptor responds proportionally to the light it gets. When horizontal cells are present, photoreceptors appear to emphasize edges. What other changes do you see? Is it easier to see the text?
	<p>1.4. Dynamic range<p>
	The retina is able to respond to light over a tremendous range of light intensities. 
	Yet our light detectors (the photoreceptors) can respond only over a relatively small range. 
	Light that is too strong or too weak can only excite or inhibit them so much before saturation occurs. 
	As we have seen, one way the visual systems solves this problem is by sampling the visual environment by two sets of detectors – rods and cones. 
	Inhibition is another mechanism by which the retina can adapt to the visual scene and expand the operating range of the photoreceptors. 
	We will now see an example of the process. Illuminate the retina with light at intensity=85%. 
	We will first see what happens in the absence of horizontal cell function. Set the Ph->H synapse to 'weak'. 
	You will see that all photoreceptors are now fully inhibited by light, as their voltage is at -20mV. Set the light level to 100%. 
	What happened to photoreceptor responses? Now, reintroduce horizontal cell function by bringing Ph->H synapse to an intermediate level. 
	What happens now when light levels are increased from -85% to 100%? 
	Can you think of the advantages and the disadvantages of the adaptation process you have observed?

	<p><b>Notes:</b></p>
	<p><b>Horizontal cells</b> are depolarized by the release of glutamate from photoreceptors, which happens in the absence of light.
	Depolarization of a horizontal cell causes it to release GABA (an inhibitory neurotransmitter) to hyperpolarize nearby photoreceptors. 
	Conversely, in the light a photoreceptor releases less glutamate, which hyperpolarizes the horizontal cell, leading to depolarization of nearby photoreceptors. 
	Thus, horizontal cells provide negative feedback (<b>feedback inhibition</b>) to photoreceptors to adjust their gain and generate <b>center-surround inhibition</b> 
	<p><b>Bipolar cells</b>  transmit signals from the photoreceptors to the ganglion cells. They can synapse with either rods or cones, and they also accept synapses from horizontal cells. 
	The bipolar cells then transmit the signals on to the amacrine and ganglion cells.
	There are roughly 10 distinct forms of cone bipolar cells, however, only one rod bipolar cell, due to the rod receptor arriving later in the evolutionary history than the cone receptor.
	In the dark, a photoreceptor (rod/cone) cell will release glutamate, 
	which inhibits (hyperpolarizes) the <b>On bipolar cells</b> and excites (depolarizes) the <b>Off bipolar cells</b>. 
	In light, reduced glutamate release from photoreceptors causes the On bipolar cell to lose its inhibition and become active (depolarized), 
	while the Off bipolar cell loses its excitation (becomes hyperpolarized) and becomes silent.
	<p><b>Amacrine cells</b> operate between bipolar cells and retinal ganglion cells. There are as many as 50 different subtypes of amacrine cells based on their dendrite morphology, stratification and genetic profile.
	Like horizontal cells, amacrine cells work laterally, but whereas horizontal cells are connected to the output of rod and cone cells, amacrine cells affect the output from bipolar cells, and are often more specialized. 
	Each type of amacrine cell releases one or several neurotransmitters where it connects with other cells. 
	Amacrine cells can greatly complicate the function of neural circuits. 
	<p><b>Ganglion cells</b>  are the final output neurons of the vertebrate retina.
	A great deal of preprocessing has been accomplished by the neurons of the vertical pathways (photoreceptor to bipolar to ganglion cell chain), and by the lateral pathways (photoreceptor to horizontal cell to bipolar to amacrine to ganglion cell chain) 
	before presentation to the ganglion cell and so it represents the ultimate signaller to the brain of retinal information. 
	It receives visual information from photoreceptors via two intermediate neuron types: bipolar cells and amacrine cells.
	There are about 0.7 to 1.5 million retinal ganglion cells in the human retina divided into 20-40 subtypes defined by their size, connections, and responses to visual stimulation.
	Ganglion cells are larger on average than most preceding retinal interneurons and all have large diameter axons capable of passing the electrical signal, 
	in the form of transient spike trains, to the retinal recipient areas of the brain many millimeters or centimeters distant from the retina. 
	These axons form the optic nerve, optic chiasm, and optic tract - we will examine them in more detail in later tutorials.
	The optic nerve collects all the axons of the ganglion cells and
	then passes information to the next relay station in the brain for sorting and integrating into further information processing channels.
	Ganglion cells collectively transmit image-forming and non-image forming visual information from the retina in the form of action potential to several regions in the thalamus, hypothalamus, and mesencephalon, or midbrain.
	On average each retinal ganglion cell receives inputs from about 100 photoreceptors.
	In the fovea (center of the retina), a single ganglion cell will have a 'private line' to a single photoreceptor. 
	In the extreme periphery (ends of the retina), a single ganglion cell will receive information from many thousands of photoreceptors.
	<p><b>Intrinsically photosensitive ganglion cells</b>.
	For the greater part of 150 years it was assumed that the mammalian retina contained only two classes of photoreceptors, rods and cones. 
	However, a flurry of studies in the late 1990s and early 2000s demonstrated the existence of a third class of mammalian photoreceptors that differs greatly from rods and cones. 
	It utilizes a different photopigment, is much less sensitive to light, responds to light far more slowly, and has far lower spatial resolution, characteristics that fit with its primary function of signaling ambient light levels (irradiance) to the brain. 
	Most surprisingly, these photoreceptors are retinal ganglion cells, and thus, have the unique ability to communicate directly with higher visual centers of the brain. 
	Photosensitive ganglion cells contain their own photopigment, melanopsin, 
	which makes them respond directly to light even in the absence of rods and cones. 
	Their primary role is to signal light for largely subconscious, 
	non-image-forming visual reflexes, such as pupillary constriction, neuroendocrine regulation, and synchronizing daily (“circadian”) physiological rhythms to the light/dark cycle (“circadian photoentrainment”).
	The intrinsic light response of intrinsically photosensitive ganglion cells differs dramatically from those of rods and cones. 
	Most notable, is the difference in response polarity: the direct photoresponse of intrinsically photosensitive ganglion cells is depolarizing, whereas rods and cones hyperpolarize to light. 
	</p><a href="https://webvision.med.utah.edu/">https://webvision.med.utah.edu/</a>
	</p><a href="https://en.wikipedia.org/wiki/Retina">https://en.wikipedia.org/wiki/Retina</a>
	</p><i> Composed by Alon Poleg-Polsky, 2019</p>alon.poleg-polsky@ucdenver.edu</i>
	</div>
	</div>
<script>

	var canvas = document.getElementById("RetinaCanvas");
	var Imagecanvas = document.getElementById("ImageCanvas");
	var ctx = canvas.getContext("2d");
	var ImgCtx = Imagecanvas.getContext("2d");
	//---variables 
	var PhNum=10,PhSpace=60,PhTop=40,PhLeft=95+60,PhWidth=3;
	var HrTop=85;
	var stimuli=new Array(PhNum);		//---stimuli
	var Ph_Vm=new Array(PhNum);			//---photoreceptors
	var HrLR_Vm=new Array(PhNum-1);		//---horizontal cells
	var HrRL_Vm=new Array(PhNum-1);		//---horizontal cells
	var OFFB_Vm=new Array(PhNum);		//---OFF bip cells
	var ONB_Vm=new Array(PhNum);		//---ON bip cells
	var ONAC_Vm=new Array(PhNum);		//---ON amacrine cells
	var GC_Vm=0;
	stimuli.fill(0.5);
	var Ph_Hr_g=0,Hr_Ph_g=0,Ph_Bip_g=0,Ph_Bip_g=0,Bip_AC_g=0,ONBip_GC_g=0,OFFBip_GC_g=0,ONBip_GS_g=0,OFFBip_GS_g=0,A_GC_g=0,A_GS_g=0;
	var OrigImage_width=100;
	var OrigImage_height=OrigImage_width;
	var OItop=20,OIleft=10;
	var ShowImage=1;
	var r=0,g=0,b=0;
	//---create 2d image array
	function CreateImageArray(rows,cols) {
		var arr = new Array(rows);
		for (var i=0;i<rows;i++) {
			arr[i] = new Array(cols);
		}
	  return arr;
	}
	//---make the original image
	function CreateOriginalImage(){
		//---the image
		ImgCtx.clearRect(0, 0, Imagecanvas.width, Imagecanvas.height);			//---erase the canvas
		ImgCtx.beginPath();
		ImgCtx.fillStyle='rgb(128,128,128)';
		ImgCtx.lineWidth=1;
		ImgCtx.strokeStyle="black";
		ImgCtx.rect(OIleft,OItop,OrigImage_width,OrigImage_height);		//---background
		ImgCtx.fill();
		ImgCtx.stroke();
		ImgCtx.closePath();
		if(ShowImage==1){
			ImgCtx.beginPath();
			var grd=ImgCtx.createLinearGradient(OIleft,OItop,OIleft+OrigImage_width,OItop);
			grd.addColorStop(0,'rgb(0,0,0)');
			grd.addColorStop(1,"white");
			ImgCtx.fillStyle=grd;
			ImgCtx.rect(OIleft+2,2+OItop,OrigImage_width-4,OrigImage_height-4);
			ImgCtx.fill();
			ImgCtx.closePath();
			ImgCtx.textAlign = "center";
			ImgCtx.font = "900 30px Arial";
			ImgCtx.beginPath();
			ImgCtx.fillStyle='rgb(0,0,0)'
			ImgCtx.fillText("Test",OIleft+OrigImage_width/2,OItop+30);
			ImgCtx.closePath();
			ImgCtx.beginPath();
			ImgCtx.fillStyle='rgb(128,128,128)'
			ImgCtx.fillText("Test",OIleft+OrigImage_width/2,OItop+60);
			ImgCtx.closePath();
			ImgCtx.beginPath();
			ImgCtx.fillStyle='rgb(255,255,255)'
			ImgCtx.fillText("Test",OIleft+OrigImage_width/2,OItop+90);
			ImgCtx.closePath();
		}
		if(ShowImage==2){
			ImgCtx.beginPath();
			var grd=ImgCtx.createLinearGradient(OIleft,OItop,OIleft+OrigImage_width,OItop);
			grd.addColorStop(0,"black");
			grd.addColorStop(1,"white");
			ImgCtx.fillStyle=grd;
			//ImgCtx.rect(OIleft+2,2+OItop,OrigImage_width-4,OrigImage_height-4);
			//ImgCtx.fill();
			//ImgCtx.closePath();
			ImgCtx.textAlign = "center";
			ImgCtx.font = "900 30px Arial";
			//ImgCtx.beginPath();
			//ImgCtx.fillStyle='rgb(0,0,0)'
			ImgCtx.fillText("Test",OIleft+OrigImage_width/2,OItop+30);
			ImgCtx.closePath();
			ImgCtx.beginPath();
			var grd=ImgCtx.createLinearGradient(OIleft,OItop,OIleft+OrigImage_width,OItop);
			grd.addColorStop(0,'rgb(64,64,64)');
			grd.addColorStop(1,'rgb(192,192,192)');
			ImgCtx.fillStyle=grd;
			ImgCtx.fillText("Test",OIleft+OrigImage_width/2,OItop+60);
			ImgCtx.closePath();
			ImgCtx.beginPath();
			var grd=ImgCtx.createLinearGradient(OIleft,OItop,OIleft+OrigImage_width,OItop);
			grd.addColorStop(0,'rgb(116,116,116)');
			grd.addColorStop(1,'rgb(140,140,140)');
			ImgCtx.fillStyle=grd;
			ImgCtx.fillText("Test",OIleft+OrigImage_width/2,OItop+90);
			ImgCtx.closePath();
		}
		if(ShowImage==3){
			ImgCtx.beginPath();
			var grd=ImgCtx.createLinearGradient(OIleft,10+OItop,OIleft,50+OItop);
			grd.addColorStop(0,"black");
			grd.addColorStop(1,"white");
			ImgCtx.fillStyle=grd;
			ImgCtx.arc(OIleft+30,OItop+30,20,Math.PI*2,0);
			ImgCtx.arc(OIleft+OrigImage_width-30,OItop+30,20,Math.PI*2,0);
			ImgCtx.fill();
			ImgCtx.closePath();
			ImgCtx.beginPath();
			ImgCtx.fillStyle='rgb(32,32,32)';
			ImgCtx.arc(OIleft+30,OItop+OrigImage_height-30,20,0,Math.PI*1);
			ImgCtx.fill();
			ImgCtx.closePath();
			ImgCtx.beginPath();
			ImgCtx.fillStyle='rgb(224,224,224)';
			ImgCtx.arc(OIleft+OrigImage_width-30,OItop+OrigImage_height-30,20,0,Math.PI*1);
			ImgCtx.fill();
			ImgCtx.closePath();
			ImgCtx.beginPath();
			ImgCtx.fillStyle='rgb(224,224,224)';
			ImgCtx.arc(OIleft+OrigImage_width-50,OItop+30,20,0,Math.PI*2);
			ImgCtx.fill();
			ImgCtx.closePath();
			}
		if(ShowImage==4){
			ImgCtx.beginPath();
			ImgCtx.fillStyle='rgb(32,32,32)';
			var grd=ImgCtx.createLinearGradient(OIleft,2+OItop,OIleft,40+OItop);
			grd.addColorStop(0,"black");
			grd.addColorStop(1,"white");
			ImgCtx.fillStyle=grd;
			for(var i=5;i<OrigImage_width-10;i+=10){
				ImgCtx.rect(i+OIleft,2+OItop,i/10,38);
			}
			ImgCtx.fill();
			ImgCtx.closePath();
			ImgCtx.beginPath();
			ImgCtx.fillStyle='rgb(224,224,224)';
			var grd=ImgCtx.createLinearGradient(OIleft,OrigImage_height-60+OItop,OIleft,OrigImage_height-10+OItop);
			grd.addColorStop(0,"black");
			grd.addColorStop(1,"white");
			ImgCtx.fillStyle=grd;
			for(var i=5;i<OrigImage_width-10;i+=10){
				ImgCtx.rect(OrigImage_width-i-10+OIleft,OrigImage_height-42+OItop,i/10,38);
				
			}
			ImgCtx.fill();
			ImgCtx.closePath();
			ImgCtx.beginPath();
			ImgCtx.fillStyle='rgb(255,255,255)';
			ImgCtx.rect(2+OIleft,17+OItop,OrigImage_width-4,10);
			ImgCtx.fill();
			ImgCtx.closePath();
			ImgCtx.beginPath();
			ImgCtx.fillStyle='rgb(0,0,0)';
			ImgCtx.rect(2+OIleft,OrigImage_height-22+OItop,OrigImage_width-4,10);

			ImgCtx.fill();
			ImgCtx.closePath();
			ImgCtx.beginPath();
			var grd=ImgCtx.createLinearGradient(2+OIleft,OItop,OrigImage_width-4+OIleft,OItop);
			grd.addColorStop(0,"black");
			grd.addColorStop(1,"white");
			ImgCtx.fillStyle=grd;
			ImgCtx.rect(2+OIleft,35+OItop,OrigImage_width-4,15);
			ImgCtx.fill();
			ImgCtx.closePath();
			ImgCtx.beginPath();
			var grd=ImgCtx.createLinearGradient(2+OIleft,OItop,OrigImage_width-4+OIleft,OItop);
			grd.addColorStop(1,"black");
			grd.addColorStop(0,"white");
			ImgCtx.fillStyle=grd;
			ImgCtx.rect(2+OIleft,OrigImage_height-50+OItop,OrigImage_width-4,15);
			ImgCtx.fill();
			ImgCtx.closePath();
		}
		//---text
		ImgCtx.beginPath();
		ImgCtx.fillStyle='rgb(0,0,0)'
		ImgCtx.strokeStyle=ctx.fillStyle;
		ImgCtx.textAlign = "center";
		ImgCtx.font = "12px Arial";
		ImgCtx.fillText("Input",OIleft+OrigImage_width/2,OItop*1-5);
		//ImgCtx.fillText("Output (Ganglion)",OIleft*2+OrigImage_width*1.5,OItop*1-5);
		ImgCtx.fillText("Photoreceptor",OIleft+OrigImage_width/2,OrigImage_height+OItop*2-5);
		ImgCtx.fillText("Horizontal",OIleft*2+OrigImage_width*1.5,OrigImage_height+OItop*2-5);
		ImgCtx.fillText("Off Bipolar",OIleft*1+OrigImage_width*0.5,OrigImage_height*2+OItop*3-5);
		ImgCtx.fillText("On Bipolar",OIleft*2+OrigImage_width*1.5,OrigImage_height*2+OItop*3-5);
		//ImgCtx.fillText("On Amacrine",OIleft*2+OrigImage_width*1.5,OrigImage_height*3+OItop*4-5);
	}
	//---initialize the field
	function Init(){
		PhNum=7
		//canvas.width=PhLeft+PhSpace*(0+PhNum)+50
		var stimuli=new Array(PhNum);		//---stimuli
		var Ph_Vm=new Array(PhNum);			//---photoreceptors
		var Hr_Vm=new Array(PhNum-1);		//---horizontal cells
		var OFFB_Vm=new Array(PhNum);		//---OFF bip cells
		var ONB_Vm=new Array(PhNum);		//---ON bip cells
		var ONAC_Vm=new Array(PhNum);		//---ON bip cells
		stimuli.fill(0.5);
		//---original image
		
		//---fill the image
		CreateOriginalImage();
	}
	//---small schematic next to cells
	function On_Off_plot(isOn,Ypos){
		var PlotLeft=10,PlotWidth=40,PlotHeight=20;
		ctx.beginPath();
		var grd=ctx.createLinearGradient(-PlotWidth*.2,0,PlotWidth*1.2,0);
		grd.addColorStop(0,"black");
		grd.addColorStop(1,"white");
		ctx.fillStyle=grd;
		ctx.lineWidth=0.5;
		ctx.strokeStyle="grey";
		ctx.moveTo(PlotLeft+isOn*PlotWidth,Ypos-PlotHeight)
		ctx.lineTo(PlotLeft+isOn*PlotWidth,Ypos);
		ctx.lineTo(PlotLeft+(isOn==0)*PlotWidth,Ypos)
		ctx.lineTo(PlotLeft+isOn*PlotWidth,Ypos-PlotHeight)
		ctx.fill();
		ctx.stroke();
		ctx.closePath();
		//---border
		ctx.beginPath();
		ctx.lineWidth=02;
		ctx.strokeStyle='rgb(0,0,0)';
		ctx.rect(PlotLeft-2,Ypos-PlotHeight*1.2,PlotWidth+4,PlotHeight*1.2);
		ctx.stroke();
		ctx.closePath();
	}
	//---cells colors
	function SetColor(val,minmax,thresh){
		r=0,g=0,b=0
		var Cbase=[128,128,128];//157,195,230
		var Cpos=[0,250,0];//204,255,50
		var Cneg=[150,0,150];//112.48,160
		if((val>minmax)&&(thresh)){
			r=val/thresh*64
			return 'rgb('+r+',0,0)'
		}else{
			if(minmax<Math.abs(val)){minmax=Math.abs(val)}
			if(val>=0){
				r=Cbase[0]+(Cpos[0]-Cbase[0])*val/minmax
				g=Cbase[1]+(Cpos[1]-Cbase[1])*val/minmax
				b=Cbase[2]+(Cpos[2]-Cbase[2])*val/minmax
			}else{
				r=Cbase[0]-(Cneg[0]-Cbase[0])*val/minmax
				g=Cbase[2]-(Cneg[1]-Cbase[1])*val/minmax
				b=Cbase[2]-(Cneg[2]-Cbase[2])*val/minmax
			}
			return 'rgb('+r+','+g+','+b+')'
		}
	}
	//---schematic dark and light symbols
	function Light_On_Off(posX,posY,posDiff){
		ctx.beginPath();
		ctx.fillStyle='rgb(0,0,0)'
		ctx.strokeStyle='rgb(0,0,0)';
		ctx.lineWidth=3;
		ctx.arc(posX,posY,3,0,2*Math.PI);
		ctx.stroke();
		ctx.fill();
		ctx.closePath();
		ctx.beginPath();
		ctx.fillStyle='rgb(255,255,255)'
		ctx.arc(posX+posDiff,posY,2,0,2*Math.PI);
		ctx.stroke();
		ctx.fill();
		ctx.closePath();
		for( var i=0;i<8;i++){
			ctx.beginPath();
			ctx.lineWidth=1;
			ctx.moveTo(posX+posDiff+4*Math.sin(Math.PI/4*i),posY+4*Math.cos(Math.PI/4*i))
			ctx.lineTo(posX+posDiff+6*Math.sin(Math.PI/4*i),posY+6*Math.cos(Math.PI/4*i))
			ctx.stroke();
			ctx.closePath();
		}
	}
	//---main drawing function
	function Circuit(){
		//---stimuli
		for( var ph=0;ph<PhNum;ph++){
			ctx.lineWidth=1;
			ctx.beginPath();
			ctx.strokeStyle='black';
			ctx.fillStyle='white';
			ctx.rect(PhLeft+PhSpace*(ph-.5)+3,1,PhSpace-6,12);//---frame
			ctx.stroke();
			ctx.fill();
			var grd=ctx.createLinearGradient(PhLeft+PhSpace*(ph-.5)+3,4,PhLeft+PhSpace*(ph-.5)+3+PhSpace-6,10);
			grd.addColorStop(0,"black");
			grd.addColorStop(1,'rgb(255,255,255)');
			ctx.beginPath();
			ctx.fillStyle=grd
			ctx.rect(PhLeft+PhSpace*(ph-.5)+12,1,PhSpace-26,12);//---dark-light
			ctx.stroke();
			ctx.fill();
			ctx.beginPath();
			ctx.fillStyle='rgb(128,128,128)';
			ctx.rect(PhLeft+PhSpace*(ph-.5)+PhSpace/2-5,1,9,12);//---grey
			ctx.stroke();
			ctx.fill();
			ctx.closePath();
			Light_On_Off(PhLeft+PhSpace*(ph-.5)+7,7,45);

			ctx.beginPath();
			ctx.strokeStyle='rgb(0,0,0)';
			ctx.fillStyle='rgb('+stimuli[ph]*255+','+stimuli[ph]*255+','+stimuli[ph]*255+')';
			ctx.rect(PhLeft+PhSpace*(ph-.5)+2,20,PhSpace-4,5);
			ctx.stroke();
			ctx.fill();
			ctx.closePath();
			ctx.beginPath();
			ctx.lineWidth=2;
			ctx.strokeStyle='rgb(0,0,0)';
			ctx.fillStyle='rgb(255,255,255)';//'rgb('+stimuli[ph]*255+','+stimuli[ph]*255+','+stimuli[ph]*255+')';
			ctx.moveTo(PhLeft+PhSpace*(ph-.5)+7+stimuli[ph]*(PhSpace-15),10)
			ctx.lineTo(PhLeft+PhSpace*(ph-.5)+7+stimuli[ph]*(PhSpace-15)+4,14)
			ctx.lineTo(PhLeft+PhSpace*(ph-.5)+7+stimuli[ph]*(PhSpace-15)+4,18)
			ctx.lineTo(PhLeft+PhSpace*(ph-.5)+7+stimuli[ph]*(PhSpace-15)-4,18)
			ctx.lineTo(PhLeft+PhSpace*(ph-.5)+7+stimuli[ph]*(PhSpace-15)-4,14)
			ctx.lineTo(PhLeft+PhSpace*(ph-.5)+7+stimuli[ph]*(PhSpace-15),10)
			ctx.stroke();
			ctx.fill();
			ctx.closePath();

		}
		Light_On_Off(10,40,40);
		//---color scale
		ctx.beginPath();
		var grd=ctx.createLinearGradient(20,215,20,295);
		grd.addColorStop(0,SetColor(30,30,0));
		grd.addColorStop(0.5,SetColor(0,30,0));
		grd.addColorStop(01,SetColor(-30,30,0));
		ctx.fillStyle=grd;
		ctx.lineWidth=1;
		ctx.rect(10,215,15,80);
		ctx.fill();
		ctx.stroke();
		ctx.closePath();
		ctx.beginPath();
		ctx.fillStyle='rgb(0,0,0)'
		ctx.strokeStyle=ctx.fillStyle;
		ctx.textAlign = "left";
		ctx.font = "12px Arial";
		ctx.fillText(" +30 mV",25,220);
		ctx.fillText("  0 mV",25,259);
		ctx.fillText(" -30 mV",25,298);
		ctx.fillStyle='rgb(255,0,0)'
		ctx.fillText(" Spike",25,242);
		ctx.moveTo(10,238)
		ctx.lineTo(25,238)
		ctx.strokeStyle=ctx.fillStyle;
		ctx.stroke();
		//---photoreceptor
		ctx.beginPath();
		ctx.fillStyle='rgb(0,0,0)'
		ctx.strokeStyle=ctx.fillStyle;
		ctx.textAlign = "right";
		ctx.font = "12px Arial";
		ctx.fillText("Photoreceptor",PhLeft-20,PhTop+45);
		ctx.lineCap="round";
		ctx.closePath();
		//---schematic plot
		On_Off_plot(0,PhTop+37)
		for( var ph=0;ph<PhNum;ph++){
			//---photoreceptor outer segment
			ctx.beginPath();
			var color=(Ph_Vm[ph]+60)*255/24;
			ctx.fillStyle=SetColor(Ph_Vm[ph],30,0)//'rgb('+Math.min(color*.1,255)+','+Math.min(color*.4,255)+','+Math.min(color,255)+')';
			ctx.strokeStyle=ctx.fillStyle;
			ctx.lineWidth=3;
			ctx.moveTo(PhLeft+PhSpace*ph-PhWidth,PhTop+40);
			ctx.lineTo(PhLeft+PhSpace*ph-PhWidth,PhTop);
			ctx.lineTo(PhLeft+PhSpace*ph+PhWidth*2,PhTop+25);
			ctx.lineTo(PhLeft+PhSpace*ph-PhWidth,PhTop+27);
			ctx.closePath();
			//---soma
			ctx.stroke();
			ctx.fill();
			ctx.beginPath();
			ctx.lineWidth=4;
			ctx.arc(PhLeft+PhSpace*ph,PhTop+40,PhWidth+2,0,2*Math.PI);
			ctx.stroke();
			ctx.fill();
			ctx.closePath();
			//---(+)
			ctx.beginPath();
			ctx.strokeStyle='white';
			ctx.lineWidth=2;
			ctx.moveTo(PhLeft+PhSpace*ph-3,PhTop+40);
			ctx.lineTo(PhLeft+PhSpace*ph+3,PhTop+40);
			//ctx.moveTo(PhLeft+PhSpace*ph,PhTop+43);
			//ctx.lineTo(PhLeft+PhSpace*ph,PhTop+37);
			ctx.stroke();
			ctx.closePath();
			//---Vm
			ctx.beginPath();
			ctx.textAlign = "left";
			ctx.font = "10px Arial";
			ctx.fillText(Ph_Vm[ph].toFixed(0)+"mV",PhLeft+PhSpace*ph,PhTop+0);
			ctx.closePath();
		}
		//---horizontal cells
		ctx.beginPath();
		ctx.fillStyle='rgb(0,0,0)'
		ctx.strokeStyle=ctx.fillStyle;
		ctx.textAlign = "right";
		ctx.font = "12px Arial";
		ctx.fillText("Horizontal",PhLeft-20,HrTop+PhSpace/4+5);
		ctx.closePath();
		//---schematic plot
		On_Off_plot(0,HrTop+PhSpace/4+5);
		for( var hc=0;hc<PhNum-1;hc++){
		//---soma---Right to Left
			ctx.beginPath();
			ctx.lineWidth=3;
			color=(HrRL_Vm[hc]+60)*255/24;
			ctx.fillStyle=SetColor(HrRL_Vm[hc],30,0)//'rgb('+Math.min(color*.1,255)+','+Math.min(color*.4,255)+','+Math.min(color,255)+')';
			ctx.strokeStyle=ctx.fillStyle;
			ctx.arc(PhLeft+PhSpace*(hc+0.5),HrTop+PhSpace/4,PhWidth+2,0,2*Math.PI);
			ctx.stroke();
			ctx.fill();
			ctx.closePath();
			//---dends
			ctx.beginPath();
			ctx.arc(PhLeft+PhSpace*(hc+0.5),HrTop-5,PhSpace/2-10,.1*Math.PI,.9*Math.PI);
			ctx.moveTo(PhLeft+PhSpace*(hc-0)+10,HrTop+5)
			ctx.lineTo(PhLeft+PhSpace*(hc-0)+10,HrTop)
			ctx.lineTo(PhLeft+PhSpace*(hc-0)+13,HrTop+2)
			ctx.stroke();
			ctx.closePath();
			//---(-)
			ctx.beginPath();
			ctx.strokeStyle='white';
			ctx.lineWidth=2;
			ctx.moveTo(PhLeft+PhSpace*(hc+0.5)-3,HrTop+PhSpace/4);
			ctx.lineTo(PhLeft+PhSpace*(hc+0.5)+3,HrTop+PhSpace/4);
			ctx.stroke();
			ctx.closePath();
			//---Vm
			ctx.textAlign = "center";
			ctx.font = "10px Arial";
			ctx.fillText(HrRL_Vm[hc].toFixed(0)+"mV",PhLeft+PhSpace*(hc+0.5),HrTop+PhSpace/4+15);
			
		//---soma---Left to Right
			ctx.beginPath();
			ctx.lineWidth=3;
			color=(HrLR_Vm[hc]+60)*255/24;
			ctx.fillStyle=SetColor(HrLR_Vm[hc],30,0)//'rgb('+Math.min(color*.1,255)+','+Math.min(color*.4,255)+','+Math.min(color,255)+')';
			ctx.strokeStyle=ctx.fillStyle;
			ctx.arc(PhLeft+PhSpace*(hc+0.5),HrTop-10-PhSpace/4,PhWidth+2,0,2*Math.PI);
			ctx.stroke();
			ctx.fill();
			ctx.closePath();
			//---dends
			ctx.beginPath();
			ctx.arc(PhLeft+PhSpace*(hc+0.5),HrTop-5,PhSpace/2-10,-.9*Math.PI,-.1*Math.PI);
			ctx.moveTo(PhLeft+PhSpace*(hc+1)-10,HrTop-15)
			ctx.lineTo(PhLeft+PhSpace*(hc+1)-10,HrTop-10)
			ctx.lineTo(PhLeft+PhSpace*(hc+1)-13,HrTop-12)
			ctx.stroke();
			ctx.closePath();
			//---(-)
			ctx.beginPath();
			ctx.strokeStyle='white';
			ctx.lineWidth=2;
			ctx.moveTo(PhLeft+PhSpace*(hc+0.5)-3,HrTop-10-PhSpace/4);
			ctx.lineTo(PhLeft+PhSpace*(hc+0.5)+3,HrTop-10-PhSpace/4);
			ctx.stroke();
			ctx.closePath();
			//---Vm
			ctx.textAlign = "center";
			ctx.font = "10px Arial";
			ctx.fillText(HrLR_Vm[hc].toFixed(0)+"mV",PhLeft+PhSpace*(hc+0.5),HrTop-PhSpace/4+8);
		}
		<!-- //---OFF/ON bipolar cells -->
		var BipSoma=[140,160];
		var BipAxon=60
		//var GangTop=250;
		ctx.beginPath();
		ctx.fillStyle='rgb(0,0,0)'
		ctx.strokeStyle=ctx.fillStyle;
		ctx.textAlign = "right";
		ctx.font = "12px Arial";
		ctx.fillText("Off Bipolar",PhLeft-20,BipSoma[0]);
		ctx.fillText("On Bipolar",PhLeft-20,BipSoma[1]);
		//---schematic plot
		On_Off_plot(0,BipSoma[0]);
		On_Off_plot(1,BipSoma[1]+8);
		ctx.closePath();
		for( var ph=0;ph<PhNum;ph++){
			for(var biptype=-1;biptype<=1;biptype+=2){
				//---soma
				var bipVm=OFFB_Vm[ph]*(biptype==-1)+ONB_Vm[ph]*(biptype==1)
				color=(bipVm)*255/24;
				
				ctx.fillStyle=SetColor(bipVm,20,0)//'rgb('+Math.min(color*.1,255)+','+Math.min(color*.4,255)+','+Math.min(color,255)+')';
				ctx.strokeStyle=ctx.fillStyle;
				ctx.lineWidth=1;
				ctx.setLineDash([1,1]);
				ctx.beginPath();
				ctx.moveTo(PhLeft+PhSpace*ph+2*biptype,PhTop+50);
				ctx.lineTo(PhLeft+PhSpace*ph+7*biptype,BipSoma[(biptype+1)/2]);
				ctx.lineTo(PhLeft+PhSpace*ph+7*biptype,BipSoma[(biptype+1)/2]+BipAxon);
				//ctx.arc(PhLeft+PhSpace*ph+285,160,300,0,2*Math.PI);
				ctx.stroke();
				//ctx.fill();
				ctx.closePath();
				ctx.beginPath();
				ctx.lineWidth=4;
				ctx.setLineDash([]);
				ctx.arc(PhLeft+PhSpace*ph+7*biptype,BipSoma[(biptype+1)/2],PhWidth+2,0,2*Math.PI);
				ctx.stroke();
				ctx.fill();
				ctx.closePath();
				//---Vm
				ctx.textAlign = "left";
				ctx.font = "10px Arial";
				ctx.fillText(bipVm.toFixed(0)+"mV",PhLeft+PhSpace*ph+7*biptype+12-biptype*2,BipSoma[(biptype+1)/2]);
				//---(+)
				ctx.beginPath();
				ctx.strokeStyle='white';
				ctx.lineWidth=2;
				ctx.moveTo(PhLeft+PhSpace*ph+7*biptype-3,BipSoma[(biptype+1)/2]);
				ctx.lineTo(PhLeft+PhSpace*ph+7*biptype+3,BipSoma[(biptype+1)/2]);
				if(biptype>0){
					ctx.moveTo(PhLeft+PhSpace*ph+7*biptype,BipSoma[(biptype+1)/2]+3);
					ctx.lineTo(PhLeft+PhSpace*ph+7*biptype,BipSoma[(biptype+1)/2]-3);
				}
				ctx.stroke();
				ctx.closePath();
			}
		}
		//---ON amacrine
		//biptype=1
		<!-- var ACsoma=BipSoma[1]+30; -->
		<!-- var ACshift=25; -->
		<!-- ctx.beginPath(); -->
		<!-- ctx.fillStyle='rgb(0,0,0)' -->
		<!-- ctx.strokeStyle=ctx.fillStyle; -->
		<!-- ctx.textAlign = "right"; -->
		<!-- ctx.font = "12px Arial"; -->
		<!-- ctx.fillText("On Amacrine",PhLeft-20,ACsoma+2); -->
		<!-- ctx.closePath(); -->
		<!-- //---schematic plot -->
		<!-- //On_Off_plot(01,ACsoma+5); -->
		<!-- for( var ph=0;ph<PhNum;ph++){ -->
			<!-- //---soma -->
			<!-- color=(ONAC_Vm[ph])*255/24; -->
			<!-- ctx.fillStyle=SetColor(ONAC_Vm[ph],20,0)//'rgb('+Math.min(color*.1,255)+','+Math.min(color*.4,255)+','+Math.min(color,255)+')'; -->
			<!-- ctx.strokeStyle=ctx.fillStyle; -->
			<!-- ctx.lineWidth=3; -->
			<!-- ctx.beginPath(); -->
			<!-- ctx.moveTo(PhLeft+PhSpace*ph+ACshift,ACsoma);			//---dend -->
			<!-- ctx.lineTo(PhLeft+PhSpace*ph+ACshift,BipAxon+BipSoma[1]); -->
			<!-- ctx.moveTo(PhLeft+PhSpace*ph+ACshift-10,ACsoma);		//---bipolar axon -->
			<!-- ctx.lineTo(PhLeft+PhSpace*ph+7,ACsoma); -->
			<!-- ctx.stroke(); -->
			<!-- ctx.closePath(); -->
			<!-- ctx.beginPath(); -->
			<!-- ctx.lineWidth=4; -->
			<!-- ctx.arc(PhLeft+PhSpace*ph+ACshift,ACsoma,PhWidth+2,0,2*Math.PI); -->
			<!-- ctx.stroke(); -->
			<!-- ctx.fill(); -->
			<!-- ctx.closePath(); -->
			<!-- //---Vm -->
			<!-- ctx.textAlign = "left"; -->
			<!-- ctx.font = "10px Arial"; -->
<!-- //			ctx.fillText(ONAC_Vm[ph].toFixed(0)+"",PhLeft+PhSpace*ph+ACshift+10,ACsoma); -->
			<!-- //---(-) -->
			<!-- ctx.beginPath(); -->
			<!-- ctx.strokeStyle='white'; -->
			<!-- ctx.lineWidth=2; -->
			<!-- ctx.moveTo(PhLeft+PhSpace*ph+ACshift-3,ACsoma); -->
			<!-- ctx.lineTo(PhLeft+PhSpace*ph+ACshift+3,ACsoma); -->
			<!-- ctx.stroke(); -->
			<!-- ctx.closePath(); -->
		<!-- } -->
		//---ganglion cell
		<!-- var Gsoma=BipAxon+BipSoma[1]+20 -->
		<!-- ctx.beginPath(); -->
		<!-- ctx.fillStyle='rgb(255,0,0)' -->
		<!-- ctx.strokeStyle=ctx.fillStyle; -->
		<!-- ctx.textAlign = "right"; -->
		<!-- ctx.font = "12px Arial"; -->
		<!-- ctx.fillText("Ganglion",PhLeft-20,Gsoma+2); -->
		<!-- ctx.closePath(); -->
		<!-- //---center-bold/surround-thin -->
		<!-- for( var ph=0;ph<PhNum;ph++){ -->
			<!-- color=(GC_Vm)*255/20; -->
			<!-- ctx.fillStyle=SetColor(GC_Vm,15,1)//'rgb('+Math.min(color*.1,255)+','+Math.min(color*.4,255)+','+Math.min(color,255)+')'; -->
			<!-- ctx.strokeStyle=ctx.fillStyle; -->
			<!-- ctx.lineWidth=1+4*(Math.abs(PhNum/2-ph-.5)<User_G_C_Num.value/2); -->
			<!-- ctx.beginPath(); -->
			<!-- ctx.moveTo(PhLeft+(PhNum-1)*PhSpace/2+7,Gsoma); -->
			<!-- ctx.lineTo(PhLeft+PhSpace*ph+ACshift,Gsoma);	 -->
			<!-- ctx.lineTo(PhLeft+PhSpace*ph+ACshift,BipAxon+BipSoma[1]+10); -->
			<!-- ctx.lineTo(PhLeft+PhSpace*ph+ACshift,Gsoma); -->
			<!-- ctx.moveTo(PhLeft+PhSpace*ph+ACshift,BipAxon+BipSoma[1]+10); -->
			<!-- ctx.moveTo(PhLeft+PhSpace*ph+7,BipSoma[1]+BipAxon+10); -->
			<!-- ctx.lineTo(PhLeft+PhSpace*ph+7,Gsoma); -->
			<!-- ctx.moveTo(PhLeft+PhSpace*ph-7,BipSoma[0]+BipAxon+10); -->
			<!-- ctx.lineTo(PhLeft+PhSpace*ph-7,Gsoma); -->
			<!-- ctx.lineTo(PhLeft+(PhNum-1)*PhSpace/2+7,Gsoma); -->
			<!-- ctx.stroke(); -->
			<!-- ctx.closePath(); -->
		<!-- } -->
		<!-- //---soma -->
		<!-- ctx.beginPath(); -->
		<!-- ctx.lineWidth=5; -->
		<!-- ctx.arc(PhLeft+(PhNum-1)*PhSpace/2+7,Gsoma+8,PhWidth+5,0,2*Math.PI); -->
		<!-- ctx.stroke(); -->
		<!-- ctx.fill(); -->
		
		<!-- ctx.setLineDash([2,6]); -->
		<!-- ctx.lineWidth=3; -->
		<!-- ctx.moveTo(PhLeft+(PhNum-1)*PhSpace/2+7,Gsoma+8) -->
		<!-- ctx.lineTo(PhLeft+(PhNum-1)*PhSpace/2+7,Gsoma+80) -->
		<!-- ctx.stroke(); -->
		<!-- ctx.setLineDash([]); -->
		<!-- ctx.closePath(); -->
		<!-- //---(+) -->
		<!-- ctx.beginPath(); -->
		<!-- ctx.strokeStyle='white'; -->
		<!-- ctx.lineWidth=2; -->
		<!-- ctx.moveTo(PhLeft+(PhNum-1)*PhSpace/2+7-4,Gsoma+8); -->
		<!-- ctx.lineTo(PhLeft+(PhNum-1)*PhSpace/2+7+4,Gsoma+8); -->
		<!-- ctx.moveTo(PhLeft+(PhNum-1)*PhSpace/2+7,Gsoma+8+4); -->
		<!-- ctx.lineTo(PhLeft+(PhNum-1)*PhSpace/2+7,Gsoma+8-4); -->
		<!-- ctx.stroke(); -->
		<!-- ctx.closePath(); -->
		<!-- //---Vm -->
		<!-- ctx.textAlign = "left"; -->
		<!-- ctx.font = "14px Arial"; -->
		<!-- ctx.fillText(GC_Vm.toFixed(0)+" mV",PhLeft+(PhNum-1)*PhSpace/2+25,Gsoma+20); -->

	}
	//---converstion of user selection of synaptic stengths
	function ComputeRetinaSyn(){
		//---outer retina
		Ph_Hr_g=User_Ph_Hz.value/20//Math.exp(User_Ph_Hz.value/40)*4*(User_Ph_Hz.value>-100)
		Hr_Ph_g=User_Hz_Ph.value/20//Math.exp(User_Hz_Ph.value/40)/8*(User_Hz_Ph.value>-100)
		Ph_Bip_g=User_Ph_Bip.value/10//Math.exp(User_Ph_Bip.value/20)/5*(User_Ph_Bip.value>-100)

	}
	//---computation of light responses
	function ComputeActivation(){
		ComputeRetinaSyn()
		var exc,inh;
		var numsteps=10;
		Ph_Vm.fill(0);
		HrRL_Vm.fill(0);
		HrLR_Vm.fill(0);
		OFFB_Vm.fill(0);
		ONB_Vm.fill(0);
		GC_Vm=0;
		
		PhThresh=-30
		for(var steps=0;steps<numsteps;steps++){
			//---activation of horizontal cells
			if(PhNum>1){
				for( var ph=0;ph<PhNum-1;ph++){
					HrLR_Vm[ph]=Ph_Hr_g*Ph_Vm[ph]
					HrRL_Vm[ph]=Ph_Hr_g*Ph_Vm[ph+1]
				}
			}
			//---horizontal to ph feedback
			for(var ph=0;ph<PhNum;ph++){
				exc=-(stimuli[ph]-0.5)*60
				inh=0
				if(PhNum>1){	//---otherwise no horizontal cells
					if(ph>0){inh=Hr_Ph_g*HrLR_Vm[ph-1]}
					if(ph<PhNum-1){	inh+=Hr_Ph_g*HrRL_Vm[ph]}
				}
				Ph_Vm[ph]=Math.min(20,Math.max(-20,exc-2*inh))
			}
			
					//---bipolar cells activation
			for(var ph=0;ph<PhNum;ph++){
			//Ph_Bip_g=1
				OFFB_Vm[ph]=Ph_Bip_g*Ph_Vm[ph]*(Ph_Vm[ph]>0)
				ONB_Vm[ph]=-Ph_Bip_g*Ph_Vm[ph]*(Ph_Vm[ph]<0)
			}

		}
	}
	//---computation of the resulting image
	function NewImage(){
		var numsteps=5,exc=0,inh=0;
		var OrigImage=CreateImageArray(OrigImage_width,OrigImage_height);
		var PhImage=CreateImageArray(OrigImage_width,OrigImage_height);
		var HzImage=CreateImageArray(OrigImage_width,OrigImage_height);
		var ONBipImage=CreateImageArray(OrigImage_width,OrigImage_height);
		var OFFBipImage=CreateImageArray(OrigImage_width,OrigImage_height);

		//---original imge and photoreceptors
		var imgData=ImgCtx.getImageData(OIleft,OItop,OrigImage_width,OrigImage_height);
		for(var i=0;i<OrigImage_width;i++){
			for(var j=0;j<OrigImage_height;j++){
				OrigImage[i][j]=imgData.data[(i+j*OrigImage_width)*4]-128;
				PhImage[i][j]=-OrigImage[i][j]/4//Math.max(-128,Math.min(128,-OrigImage[i][j]/1));
			}
		}
		//---computation
		var HorizIn=4,HorizInAdj=(HorizIn*2+1)*(HorizIn*2+1)/10;
		for(var steps=0;steps<numsteps;steps++){
			//if(PhNum>1){	//---otherwise no horizontal cells
				for(var i=0;i<OrigImage_width;i++){
					for(var j=0;j<OrigImage_height;j++){
						//---horizontal cells
						HzImage[i][j]=0
						for(var hi=-HorizIn;hi<=HorizIn;hi++){
							for(var hj=-HorizIn;hj<=HorizIn;hj++){
								var iloc=Math.min(OrigImage_width-1,Math.max(0,i+hi));
								var jloc=Math.min(OrigImage_height-1,Math.max(0,j+hj));
								if((hi!=0)&&(hj!=0)){HzImage[i][j]+=PhImage[iloc][jloc]*Ph_Hr_g/HorizInAdj}
							}
						}
					}
				}
				
			//}
			//---photoreceptors
			for(var i=0;i<OrigImage_width;i++){
				for(var j=0;j<OrigImage_height;j++){
					inh=0
					//if(PhNum>1){	//---otherwise no horizontal cells
						inh+=HzImage[i][j]*Hr_Ph_g
					//}
					//---Photoreceptos
					exc=-(OrigImage[i][j])
					PhImage[i][j]=exc-inh
				}
			}
		}
		//---photoreceptors
		var minval=255,maxval=0;
		for(var i=0;i<OrigImage_width;i++){
			for(var j=0;j<OrigImage_height;j++){
				minval=Math.min(PhImage[i][j],minval)
				maxval=Math.max(PhImage[i][j],maxval)
			}
		}
		for(var i=0;i<OrigImage_width;i++){
			for(var j=0;j<OrigImage_height;j++){
				SetColor(PhImage[i][j],Math.max(maxval,Math.abs(minval)),0)
				imgData.data[(i+j*OrigImage_width)*4]=r
				imgData.data[(i+j*OrigImage_width)*4+1]=g
				imgData.data[(i+j*OrigImage_width)*4+2]=b
			}
		}
		ImgCtx.putImageData(imgData,OIleft,OrigImage_height+OItop*2);
		//---horizontal
		var minval=255,maxval=0;
		for(var i=0;i<OrigImage_width;i++){
			for(var j=0;j<OrigImage_height;j++){
				minval=Math.min(HzImage[i][j],minval)
				maxval=Math.max(HzImage[i][j],maxval)
			}
		}
		for(var i=0;i<OrigImage_width;i++){
			for(var j=0;j<OrigImage_height;j++){
				SetColor(HzImage[i][j],Math.max(maxval,Math.abs(minval)),0)
				imgData.data[(i+j*OrigImage_width)*4]=r
				imgData.data[(i+j*OrigImage_width)*4+1]=g
				imgData.data[(i+j*OrigImage_width)*4+2]=b
			}
		}
		ImgCtx.putImageData(imgData,OIleft*2+OrigImage_width,OrigImage_height+OItop*2);
		
		//---bipolar/amacrine  cells activation - not part of the loop as are only excited
		for(var i=0;i<OrigImage_width;i++){
			for(var j=0;j<OrigImage_height;j++){
				OFFBipImage[i][j]=(PhImage[i][j]>0)*Ph_Bip_g*(PhImage[i][j])
				ONBipImage[i][j]=(PhImage[i][j]<0)*Ph_Bip_g*(-PhImage[i][j])
//				ONACImage[i][j]=ONBipImage[i][j]*Bip_AC_g;
			}
		}
		<!-- //---off bipolar -->
		for(var i=0;i<OrigImage_width;i++){
			for(var j=0;j<OrigImage_height;j++){
				SetColor(OFFBipImage[i][j],30,0)
				imgData.data[(i+j*OrigImage_width)*4]=r
				imgData.data[(i+j*OrigImage_width)*4+1]=g
				imgData.data[(i+j*OrigImage_width)*4+2]=b
			}
		}
		ImgCtx.putImageData(imgData,OIleft,OrigImage_height*2+OItop*3);
		//---on bipolar
		for(var i=0;i<OrigImage_width;i++){
			for(var j=0;j<OrigImage_height;j++){
				SetColor(ONBipImage[i][j],30,0)
				imgData.data[(i+j*OrigImage_width)*4]=r
				imgData.data[(i+j*OrigImage_width)*4+1]=g
				imgData.data[(i+j*OrigImage_width)*4+2]=b
			}
		}
		ImgCtx.putImageData(imgData,OIleft*2+OrigImage_width,OrigImage_height*2+OItop*3);
		<!-- //---on amacrine -->
		<!-- for(var i=0;i<OrigImage_width;i++){ -->
			<!-- for(var j=0;j<OrigImage_height;j++){ -->
				<!-- SetColor(ONACImage[i][j],30,0) -->
				<!-- imgData.data[(i+j*OrigImage_width)*4]=r -->
				<!-- imgData.data[(i+j*OrigImage_width)*4+1]=g -->
				<!-- imgData.data[(i+j*OrigImage_width)*4+2]=b -->
			<!-- } -->
		<!-- } -->
		<!-- ImgCtx.putImageData(imgData,OIleft*2+OrigImage_width,OrigImage_height*3+OItop*4); -->
		<!-- var CenterSpan=Math.round(User_G_C_Num.value/2) -->
		<!-- var NumSpikes=0 -->
		<!-- for(var i=1;i<OrigImage_width/PhNum-2;i++){ -->
			<!-- for(var j=1;j<OrigImage_width/PhNum-2;j++){ -->
				<!-- exc=0 -->
				<!-- inh=0 -->
				<!-- var iloc=i*PhNum -->
				<!-- var jloc=j*PhNum -->
				<!-- var GangCAdj=CenterSpan*CenterSpan; -->
				<!-- var GangSAdj=(PhNum*PhNum/2-GangCAdj); -->
				<!-- for(var gi=0;gi<PhNum;gi++){ -->
					<!-- for(var gj=0;gj<PhNum;gj++){ -->
						<!-- if((iloc+gi>=0)&&(iloc+gi<OrigImage_width)&&(jloc+gj>=0)&&(jloc+gj<OrigImage_width)){ -->
							<!-- if( (gi>=PhNum/2-CenterSpan)&&(gi<=PhNum/2+CenterSpan)&&(gj>=PhNum/2-CenterSpan)&&(gj<=PhNum/2+CenterSpan) ){	//---center -->
								<!-- exc+=ONBipImage[iloc+gi][jloc+gj]*ONBip_GC_g/GangCAdj -->
								<!-- exc+=OFFBipImage[iloc+gi][jloc+gj]*OFFBip_GC_g/GangCAdj -->
								<!-- inh+=ONACImage[iloc+gi][jloc+gj]*A_GC_g/GangCAdj -->
							<!-- }else{																			//---surround -->
								<!-- exc+=ONBipImage[iloc+gi][jloc+gj]*ONBip_GS_g/GangSAdj -->
								<!-- exc+=OFFBipImage[iloc+gi][jloc+gj]*OFFBip_GS_g/GangSAdj -->
								<!-- inh+=ONACImage[iloc+gi][jloc+gj]*A_GS_g/GangSAdj -->
							<!-- } -->
						<!-- } -->
					<!-- } -->
				<!-- } -->
				<!-- //GangImage[i][j]=exc-inh -->
				<!-- NumSpikes+=((exc-inh)>=15) -->
				<!-- ImgCtx.beginPath(); -->
				<!-- //ImgCtx.fillStyle=SetColor(exc-inh,15,1) -->
				<!-- ImgCtx.fillStyle='rgb('+((exc-inh)>=15)*255+',0,0)' -->
				<!-- ImgCtx.rect(120+iloc,20+jloc,PhNum,PhNum); -->
				<!-- ImgCtx.fill(); -->
				<!-- ImgCtx.closePath(); -->
			<!-- } -->
		<!-- }//---done computing -->
		//---report
		//ImgCtx.clearRect(0, OIleft*3+OItop*4, OrigImage_width, OrigImage_height);			//---erase the canvas
		<!-- ImgCtx.beginPath(); -->
		<!-- ImgCtx.fillStyle='rgb(200,200,200)'; -->
		<!-- ImgCtx.strokeStyle='rgb(0,0,0)'; -->
		<!-- ImgCtx.lineWidth=0; -->
		<!-- ImgCtx.rect(OIleft*1,OrigImage_height*3+OItop*4-15, OrigImage_width, OrigImage_height+15); -->
		<!-- ImgCtx.stroke(); -->
		<!-- ImgCtx.fill(); -->
		<!-- ImgCtx.beginPath(); -->
		<!-- ImgCtx.fillStyle='rgb(128,128,128)'; -->
		<!-- ImgCtx.rect(OIleft*1,OrigImage_height*3+OItop*4-15, OrigImage_width, 14); -->
		<!-- ImgCtx.stroke(); -->
		<!-- ImgCtx.fill(); -->
		<!-- ImgCtx.closePath(); -->
		<!-- ImgCtx.beginPath(); -->
		<!-- ImgCtx.fillStyle='rgb(255,255,255)' -->
		<!-- ImgCtx.strokeStyle=ctx.fillStyle; -->
		<!-- ImgCtx.textAlign = "center"; -->
		<!-- ImgCtx.font = "11px Arial"; -->
		<!-- ImgCtx.fillText("Report",OIleft+OrigImage_width*0.5,OrigImage_height*3+OItop*4-5); -->
		<!-- ImgCtx.fillStyle='rgb(0,0,0)' -->
		<!-- ImgCtx.textAlign = "left"; -->
		<!-- ImgCtx.fillText("Input=10,000px",OIleft+2,OrigImage_height*3+OItop*4+20); -->
		<!-- ImgCtx.fillText(Math.floor(10000/PhNum/PhNum)+" Ganglion cells",OIleft+2,OrigImage_height*3+OItop*4+35); -->
		<!-- ImgCtx.fillText("Compression="+Math.floor(100/PhNum/PhNum)+"%",OIleft+2,OrigImage_height*3+OItop*4+50); -->
		<!-- ImgCtx.fillText("#Spikes="+NumSpikes,OIleft+2,OrigImage_height*3+OItop*4+65); -->
		<!-- ImgCtx.fillText("Energy="+Math.round(NumSpikes/100)+"%",OIleft+2,OrigImage_height*3+OItop*4+80); -->

	}
	//---computes and plots retinal elements
	function DrawCanvas(doInit){
		ctx.clearRect(0, 0, canvas.width, canvas.height);
		if(doInit){Init()}
		ComputeActivation();
		NewImage();
		Circuit();
	}
	canvas.onclick= function(){
		if( (event.offsetX>PhLeft-PhSpace/2)&&(event.offsetX<PhLeft+PhSpace*PhNum)){
			if( (event.offsetY>1)&&(event.offsetY<20)){
				var stimNum=Math.floor((Number(event.offsetX)-PhLeft+PhSpace/2)/PhSpace)
				if((stimNum<PhNum)&&(stimNum>=0)){
					stimuli[stimNum]=(Number(event.offsetX)-(PhLeft+PhSpace*(stimNum-.5)+3))/(PhSpace-6)
					if(event.offsetY<12){
						if(stimuli[stimNum]>0.8){stimuli[stimNum]=1}
						if(stimuli[stimNum]<0.2){stimuli[stimNum]=0}
						if(Math.abs(stimuli[stimNum]-0.5)<0.1){stimuli[stimNum]=0.5}
					}
					//alert(stimNum)
					stimuli[stimNum]=Math.max(0,stimuli[stimNum])
					stimuli[stimNum]=Math.min(1,stimuli[stimNum])
				//if(stimuli[stimNum]==0.5){
				//	stimuli[stimNum]=1
				//}else{
				//	if(stimuli[stimNum]==1){
				//		stimuli[stimNum]=0
				//	}else{
				//		stimuli[stimNum]=.5
				//	}
				}
			}
		}
		DrawCanvas(0);
	};
	ImageCanvas.onclick= function(){
		ShowImage++;
		if(ShowImage>4){ShowImage=1}
		DrawCanvas(1);
	}
	//var User_Ph_Num = document.getElementById("Ph_Num");
	var User_Ph_Hz = document.getElementById("Ph_Hz");
	var User_Hz_Ph = document.getElementById("Hz_Ph");
	var User_Ph_Bip = document.getElementById("Ph_Bip");
	var User_Bip_AC = document.getElementById("Bip_AC");
	var User_G_C_Num = document.getElementById("G_C_Num");
	var User_ONBip_GC = document.getElementById("ONBip_GC");
	var User_OFFBip_GC = document.getElementById("OFFBip_GC");
	var User_ONBip_GS = document.getElementById("ONBip_GS");
	var User_OFFBip_GS = document.getElementById("OFFBip_GS");
	var User_A_GC = document.getElementById("A_GC");
	var User_A_GS = document.getElementById("A_GS");
	var ONCentersmall = document.getElementById("ONCentersmall");
	var ONCenterlarge = document.getElementById("ONCenterlarge");
	var OnFoveal = document.getElementById("OnFoveal");
	var OffFoveal = document.getElementById("OffFoveal");
	var Light0 = document.getElementById("Light0");
	var Light15 = document.getElementById("Light15");
	var Light50 = document.getElementById("Light50");
	var Light85 = document.getElementById("Light85");
	var Light100 = document.getElementById("Light100");

	DrawCanvas(1)
	//User_Ph_Num.oninput = function() {DrawCanvas(1)}
	User_Ph_Hz.oninput = function() {DrawCanvas(0)}
	User_Hz_Ph.oninput = function() {DrawCanvas(0)}
	User_Ph_Bip.oninput = function() {DrawCanvas(0)}
	<!-- User_Bip_AC.oninput = function() {DrawCanvas(0)} -->
	<!-- User_G_C_Num.oninput = function() {DrawCanvas(0)} -->
	<!-- User_ONBip_GC.oninput = function() {DrawCanvas(0)} -->
	<!-- User_OFFBip_GC.oninput = function() {DrawCanvas(0)} -->
	<!-- User_ONBip_GS.oninput = function() {DrawCanvas(0)} -->
	<!-- User_OFFBip_GS.oninput = function() {DrawCanvas(0)} -->
	<!-- User_A_GC.oninput = function() {DrawCanvas(0)} -->
	<!-- User_A_GS.oninput = function() {DrawCanvas(0)} -->
	Light0.onclick = function() {
		for( var ph=0;ph<PhNum;ph++){stimuli[ph]=0}
		DrawCanvas(1)
	}
	Light15.onclick = function() {
		for( var ph=0;ph<PhNum;ph++){stimuli[ph]=.15}
		DrawCanvas(1)
	}
	Light50.onclick = function() {
		for( var ph=0;ph<PhNum;ph++){stimuli[ph]=.5}
		DrawCanvas(1)
	}
	Light85.onclick = function() {
		for( var ph=0;ph<PhNum;ph++){stimuli[ph]=.85}
		DrawCanvas(1)
	}
	Light100.onclick = function() {
		for( var ph=0;ph<PhNum;ph++){stimuli[ph]=1}
		DrawCanvas(1)
	}
	<!-- OnFoveal.onclick = function() { -->
		<!-- PhNum=1; -->
		<!-- //User_Ph_Num.value=1; -->
		<!-- User_G_C_Num.value=1; -->
		<!-- User_ONBip_GC.value=4; -->
		<!-- User_OFFBip_GC.value=0 -->
		<!-- User_A_GC.value=1 -->
		<!-- DrawCanvas(1) -->
	<!-- } -->
	<!-- OffFoveal.onclick = function() { -->
		<!-- PhNum=1; -->
		<!-- //User_Ph_Num.value=1; -->
		<!-- User_G_C_Num.value=1; -->
		<!-- User_ONBip_GC.value=0; -->
		<!-- User_OFFBip_GC.value=03; -->
		<!-- User_A_GC.value=1 -->
		<!-- DrawCanvas(1) -->
	<!-- } -->
	<!-- ONCentersmall.onclick = function() { -->
		<!-- PhNum=3; -->
		<!-- //User_Ph_Num.value=3; -->
		<!-- User_G_C_Num.value=1; -->
		<!-- User_ONBip_GC.value=4; -->
		<!-- User_OFFBip_GC.value=0 -->
		<!-- User_ONBip_GS.value=0 -->
		<!-- User_OFFBip_GS.value=0 -->
		<!-- User_A_GC.value=0 -->
		<!-- User_A_GS.value=3; -->
		<!-- DrawCanvas(1) -->
	<!-- } -->
	<!-- ONCenterlarge.onclick = function() { -->
		<!-- PhNum=7; -->
		<!-- //User_Ph_Num.value=7; -->
		<!-- User_G_C_Num.value=3; -->
		<!-- User_ONBip_GC.value=4; -->
		<!-- User_OFFBip_GC.value=0 -->
		<!-- User_ONBip_GS.value=0 -->
		<!-- User_OFFBip_GS.value=0 -->
		<!-- User_A_GC.value=0 -->
		<!-- User_A_GS.value=3; -->
		<!-- DrawCanvas(1) -->
	<!-- } -->
</script>

</body>
</html>
